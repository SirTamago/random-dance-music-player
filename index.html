<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RDP Pro v4 (Offline Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- WaveSurfer 7 + Regions -->
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .spotify-green { color: #1DB954; }
        .bg-spotify-green { background-color: #1DB954; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.2s ease; }

        /* 导出容器：移出屏幕，定宽 */
        #export-canvas {
            width: 800px;
            height: auto;
            position: fixed;
            top: 0; left: -9999px;
            background-color: #080808; /* 极深灰背景 */
            padding: 60px;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-black text-white">

<!-- 1. 顶部栏 -->
<header class="h-14 flex justify-between items-center px-4 bg-zinc-900 border-b border-zinc-800 z-20">
    <h1 class="text-base font-bold flex items-center gap-2">
        <i class="fa-solid fa-sliders spotify-green"></i> RDP <span class="text-[10px] bg-zinc-700 px-1 rounded text-gray-300">v4</span>
    </h1>
    <div class="flex gap-2">
        <input type="file" id="config-input" accept=".json" class="hidden" onchange="loadConfig(this.files[0])">
        <button onclick="document.getElementById('config-input').click()" class="text-xs bg-zinc-800 border border-zinc-700 px-3 py-1 rounded hover:bg-zinc-700 transition"><i class="fa-solid fa-file-import"></i> 导入</button>
        <button onclick="saveConfig()" class="text-xs bg-zinc-800 border border-zinc-700 px-3 py-1 rounded hover:bg-zinc-700 transition"><i class="fa-solid fa-floppy-disk"></i> 保存</button>
        <button onclick="exportImage()" class="text-xs bg-zinc-800 border border-zinc-700 px-3 py-1 rounded hover:bg-zinc-700 transition"><i class="fa-solid fa-image"></i> 图片</button>
    </div>
</header>

<!-- 2. 主列表 -->
<main class="flex-1 overflow-y-auto no-scrollbar relative bg-black" id="main-area">
    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-500">
        <div class="w-16 h-16 bg-zinc-800 rounded-full flex items-center justify-center mb-4">
            <i class="fa-solid fa-music text-3xl text-zinc-600"></i>
        </div>
        <p class="text-sm text-gray-400 mb-6">MP3 / AAC / JSON Config</p>
        <label class="bg-white text-black font-bold py-2 px-6 rounded-full cursor-pointer hover:scale-105 transition transform text-sm">
            添加歌曲
            <input type="file" multiple accept="audio/*" class="hidden" onchange="handleFiles(this.files)">
        </label>
    </div>

    <div id="song-list-container" class="hidden pb-32 pt-2">
        <div class="flex justify-between items-center px-4 mb-2">
            <span class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest" id="list-title">Setlist</span>
            <div class="flex gap-4">
                 <button onclick="forceDownloadCheck()" class="text-[10px] font-bold text-gray-400 hover:text-white uppercase"><i class="fa-solid fa-cloud-arrow-down"></i> Cache Check</button>
                 <label class="text-spotify-green text-[10px] font-bold cursor-pointer hover:underline">
                    + ADD MORE
                    <input type="file" multiple accept="audio/*" class="hidden" onchange="handleFiles(this.files)">
                </label>
            </div>
        </div>
        <ul id="song-list" class="space-y-0.5 px-2"></ul>
    </div>
</main>

<!-- 3. 底部播放条 -->
<footer class="h-20 bg-zinc-900 border-t border-zinc-800 flex items-center px-4 justify-between z-30 fixed bottom-0 w-full">
    <div class="flex items-center w-[30%] overflow-hidden">
        <div class="flex flex-col overflow-hidden justify-center">
            <span id="player-title" class="text-sm font-bold truncate text-white">Ready</span>
            <span id="player-status" class="text-[10px] text-gray-400 truncate">--</span>
        </div>
    </div>

    <div class="flex flex-col items-center w-[40%]">
        <div class="flex items-center gap-6 mb-1">
            <button onclick="playPrev()" class="text-gray-400 hover:text-white disabled:opacity-30" id="btn-prev" disabled><i class="fa-solid fa-backward-step text-lg"></i></button>
            <button onclick="toggleMainPlay()" id="btn-play" class="w-9 h-9 bg-white rounded-full flex items-center justify-center hover:scale-105 transition text-black disabled:opacity-50" disabled><i class="fa-solid fa-play"></i></button>
            <button onclick="playNext()" class="text-gray-400 hover:text-white disabled:opacity-30" id="btn-next" disabled><i class="fa-solid fa-forward-step text-lg"></i></button>
        </div>
        <div class="w-full flex items-center gap-2 text-[9px] text-gray-500 font-mono">
            <span id="time-display">00:00</span>
            <div class="flex-1 h-1 bg-zinc-700 rounded-full overflow-hidden relative">
                <div id="progress-bar" class="h-full bg-spotify-green w-0 transition-all duration-300"></div>
            </div>
        </div>
    </div>

    <div class="flex items-center justify-end w-[30%] gap-2">
        <button onclick="startRandomMode()" id="btn-mode-random" class="text-[10px] font-bold px-3 py-1.5 rounded-full bg-zinc-800 text-gray-300 hover:text-white border border-zinc-700">RANDOM</button>
        <button onclick="stopAll()" id="btn-stop" class="hidden text-[10px] font-bold px-3 py-1.5 rounded-full bg-red-900/40 text-red-400 border border-red-900">STOP</button>
    </div>
</footer>

<!-- 4. Au风格全览编辑器 -->
<div id="editor-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col opacity-0 modal">
    <div class="h-12 px-4 flex justify-between items-center bg-zinc-900 border-b border-zinc-800">
        <span class="text-xs font-bold text-gray-300">Waveform Editor</span>
        <button onclick="closeEditor()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
    </div>
    <div class="flex-1 flex flex-col px-4 justify-center relative">
        <h3 id="editor-title" class="text-center text-lg font-bold mb-8 text-white truncate">Song Title</h3>
        <div class="relative w-full h-48 bg-zinc-900 rounded-lg border border-zinc-700 overflow-hidden shadow-2xl">
            <div id="waveform-full" class="w-full h-full"></div>
            <div id="editor-loading" class="absolute inset-0 flex items-center justify-center text-xs text-gray-500 hidden z-10 bg-black/50">
                <i class="fa-solid fa-spinner fa-spin mr-2"></i> Loading Audio...
            </div>
        </div>
        <div class="flex justify-between mt-2 text-[10px] text-gray-500 font-mono">
            <span>00:00</span>
            <span class="text-center flex-1"><i class="fa-solid fa-hand-pointer mr-1"></i> 点击波形听歌 / 拖动绿色方块选区</span>
            <span id="editor-total-duration">--:--</span>
        </div>
        <div class="flex justify-center gap-6 mt-8 text-xs font-mono">
            <div class="bg-zinc-800 px-4 py-3 rounded text-gray-300 flex flex-col items-center min-w-[120px]">
                <span class="text-[10px] text-zinc-500 uppercase tracking-widest mb-1">Start Time</span>
                <span id="region-start" class="text-white font-bold text-lg">00:00.00</span>
            </div>
            <div class="bg-zinc-800 px-4 py-3 rounded text-gray-300 flex flex-col items-center min-w-[120px]">
                <span class="text-[10px] text-zinc-500 uppercase tracking-widest mb-1">Duration</span>
                <span id="region-duration" class="text-spotify-green font-bold text-lg">00:00.00</span>
            </div>
        </div>
    </div>
    <div class="p-6 bg-zinc-900 border-t border-zinc-800 flex justify-between items-center">
        <div class="flex gap-4">
            <button id="editor-play-btn" onclick="toggleEditorPlay()" class="w-10 h-10 rounded-full bg-zinc-700 hover:bg-zinc-600 flex items-center justify-center text-white transition"><i class="fa-solid fa-play"></i></button>
            <button onclick="previewRegion()" class="px-5 h-10 rounded-full bg-zinc-800 hover:bg-zinc-700 text-xs font-bold text-spotify-green border border-zinc-700 transition"><i class="fa-solid fa-rotate-right mr-2"></i> Try Loop</button>
        </div>
        <button onclick="saveEditor()" class="px-8 h-10 bg-white text-black font-bold rounded-full text-xs hover:bg-gray-200">Save & Close</button>
    </div>
</div>

<!-- 5. 倒计时层 -->
<div id="countdown-layer" class="fixed inset-0 bg-black z-[60] hidden flex items-center justify-center flex-col select-none">
    <div id="cnt-num" class="text-[120px] font-black text-spotify-green leading-none">3</div>
    <div class="mt-4 text-xl font-bold text-white flex flex-col items-center">
        <span class="text-zinc-600 text-[10px] uppercase tracking-[0.3em] mb-2">Up Next</span>
        <span id="cnt-next-name" class="text-center px-4">Song Name</span>
    </div>
</div>

<!-- 6. 新增：下载进度弹窗 -->
<div id="download-modal" class="fixed inset-0 bg-black/90 z-[70] hidden flex flex-col items-center justify-center p-8 select-none">
    <i class="fa-solid fa-cloud-arrow-down text-4xl text-spotify-green mb-6 animate-bounce"></i>
    <h2 class="text-2xl font-bold mb-2">Caching Audio...</h2>
    <p class="text-gray-400 text-sm mb-8 text-center max-w-md">Downloading songs to memory for smooth playback.<br>Do not close this tab.</p>

    <div class="w-full max-w-md h-2 bg-zinc-800 rounded-full overflow-hidden mb-2">
        <div id="download-bar" class="h-full bg-spotify-green w-0 transition-all duration-300"></div>
    </div>
    <div class="flex justify-between w-full max-w-md text-xs font-mono text-gray-500 mb-8">
        <span id="download-count">0 / 0</span>
        <span id="download-percent">0%</span>
    </div>

    <div class="text-xs text-red-500 h-4 mb-4" id="download-error"></div>

    <button onclick="cancelDownload()" class="px-6 py-2 rounded-full border border-zinc-600 text-zinc-400 hover:text-white hover:border-white text-xs font-bold transition">CANCEL</button>
</div>

<!-- 7. 导出图片生成区 -->
<div id="export-canvas">
    <div class="mb-12">
        <h1 class="text-7xl font-black italic tracking-tighter text-white mb-2">SETLIST</h1>
        <div class="h-1 w-20 bg-spotify-green"></div>
        <p class="text-zinc-500 text-sm mt-4 tracking-[0.2em] uppercase font-bold">Random Dance Play</p>
    </div>
    <ul id="export-list-ul" class="grid grid-cols-1 gap-8"></ul>
    <div class="mt-16 text-right"><span class="text-zinc-700 text-xs uppercase tracking-widest font-bold border border-zinc-800 px-2 py-1 rounded">RDP Generated</span></div>
</div>

<script>
    let playlist = [];
    let playQueue = [];
    let currentIndex = -1;
    let isRandomMode = false;
    let isDownloading = false;
    let downloadAbortController = null;

    let audio = new Audio();
    let audioCtx = null;
    let playState = { timerId: null, remainingTime: 0, isPlaying: false };
    let ws = null;
    let wsRegion = null;
    let currentEditId = null;

    // ==========================================
    // 0. 下载管理器 (新增核心功能)
    // ==========================================

    function forceDownloadCheck() {
        const needsDl = playlist.filter(s => s.url && !s.file);
        if (needsDl.length > 0) {
            startDownloadProcess(needsDl);
        } else {
            alert("All songs are cached locally or have no URL.");
        }
    }

    async function startDownloadProcess(itemsToDownload) {
        if (isDownloading) return;
        isDownloading = true;
        downloadAbortController = new AbortController();
        const signal = downloadAbortController.signal;

        const modal = document.getElementById('download-modal');
        const bar = document.getElementById('download-bar');
        const countTxt = document.getElementById('download-count');
        const pctTxt = document.getElementById('download-percent');
        const errTxt = document.getElementById('download-error');
        
        modal.classList.remove('hidden');
        errTxt.innerText = "";

        let total = itemsToDownload.length;
        let completed = 0;
        let errors = 0;

        // update UI init
        countTxt.innerText = `0 / ${total}`;
        bar.style.width = '0%';

        // 每次并发下载3个，避免浏览器卡死
        const batchSize = 3; 
        
        for (let i = 0; i < total; i += batchSize) {
            if (signal.aborted) break;

            const batch = itemsToDownload.slice(i, i + batchSize);
            const promises = batch.map(song => fetchAndCacheSong(song, signal));
            
            const results = await Promise.all(promises);
            
            results.forEach(res => {
                if (res) completed++;
                else errors++;
            });

            // Update UI
            const pct = Math.round((completed + errors) / total * 100);
            bar.style.width = `${pct}%`;
            countTxt.innerText = `${completed + errors} / ${total}`;
            pctTxt.innerText = `${pct}%`;
        }

        isDownloading = false;
        setTimeout(() => {
            modal.classList.add('hidden');
            renderList(); // 刷新列表状态
            if (errors > 0) {
                alert(`Download finished. ${completed} success, ${errors} failed (Check CORS or URL).`);
            }
        }, 500);
    }

    async function fetchAndCacheSong(song, signal) {
        try {
            const response = await fetch(song.url, { signal });
            if (!response.ok) throw new Error("Net Error");
            const blob = await response.blob();
            // 关键：把下载的 blob 伪装成 File 对象存入 playlist
            // 这样播放器逻辑就认为它是本地文件，读取速度极快
            song.file = new File([blob], song.name + ".mp3", { type: "audio/mpeg" });
            return true;
        } catch (e) {
            console.error(`Failed to download ${song.name}:`, e);
            return false;
        }
    }

    function cancelDownload() {
        if (downloadAbortController) {
            downloadAbortController.abort();
            isDownloading = false;
            document.getElementById('download-modal').classList.add('hidden');
            alert("Download cancelled. Some songs may still stream from URL.");
        }
    }


    // ==========================================
    // 1. 播放控制
    // ==========================================

    function playSong(song) {
        let src = null;
        // 优先使用内存中的 File (无论是本地上传的还是刚刚下载的)
        if (song.file) {
            src = URL.createObjectURL(song.file);
        } else if (song.url) {
            src = song.url; // 降级：如果没下载成功，还是尝试用 URL
        }

        if (!src) { playNext(); return; }

        audio.src = src;
        audio.currentTime = song.start;

        playState.remainingTime = song.duration;
        playState.isPlaying = true;

        document.getElementById('player-title').innerText = song.name;
        document.getElementById('player-status').innerText = `Playing`;
        document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-pause"></i>';
        document.getElementById('btn-play').disabled = false;

        audio.play().then(() => startTimerLoop()).catch(e => { console.error(e); playNext(); });
    }

    function startTimerLoop() {
        if (playState.timerId) clearInterval(playState.timerId);
        playState.timerId = setInterval(() => {
            if (audio.paused) return;
            playState.remainingTime--;
            updateProgressUI(playState.remainingTime);
            if (playState.remainingTime <= 0) {
                stopTimerAndAudio();
                playNext();
            }
        }, 1000);
    }

    function toggleMainPlay() {
        if (!audio.src) return;
        if (playState.isPlaying) {
            audio.pause();
            clearInterval(playState.timerId); 
            playState.isPlaying = false;
            document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-play"></i>';
            document.getElementById('player-status').innerText = "Paused";
        } else {
            audio.play();
            startTimerLoop(); 
            playState.isPlaying = true;
            document.getElementById('btn-play').innerHTML = '<i class="fa-solid fa-pause"></i>';
        }
    }

    function updateProgressUI(left) {
        const currentSong = isRandomMode ? playQueue[currentIndex] : playlist[currentIndex];
        if(!currentSong) return;
        const total = currentSong.duration;
        const pct = Math.max(0, ((total - left) / total) * 100);
        document.getElementById('progress-bar').style.width = `${pct}%`;
        document.getElementById('time-display').innerText = `-${left}s`;
    }

    function playNext() { stopTimerAndAudio(); if(isRandomMode) { currentIndex++; if(currentIndex>=playQueue.length){alert("End!"); stopAll();} else startCountdown(playQueue[currentIndex]); } }
    function playPrev() { stopTimerAndAudio(); if(isRandomMode && currentIndex>0) { currentIndex--; startCountdown(playQueue[currentIndex]); } }
    function stopTimerAndAudio() { if (playState.timerId) clearInterval(playState.timerId); audio.pause(); playState.isPlaying = false; }

    // ==========================================
    // 2. 编辑器
    // ==========================================

    function openEditor(id) {
        const song = playlist.find(s => s.id === id);
        if (!song) return;
        currentEditId = id;

        const modal = document.getElementById('editor-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        document.getElementById('editor-title').innerText = song.name;
        document.getElementById('editor-loading').classList.remove('hidden');

        if (ws) ws.destroy();

        ws = WaveSurfer.create({
            container: '#waveform-full',
            waveColor: '#555',
            progressColor: '#fff', 
            height: 192, 
            barWidth: 2,
            cursorColor: '#1DB954',
            cursorWidth: 1,
            fillParent: true, 
            autoScroll: false, 
            plugins: [ WaveSurfer.Regions.create() ]
        });

        let src = null;
        if (song.file) src = URL.createObjectURL(song.file);
        else if (song.url) src = song.url;

        ws.load(src);

        ws.on('ready', () => {
            document.getElementById('editor-loading').classList.add('hidden');
            document.getElementById('editor-total-duration').innerText = formatTimeSimple(ws.getDuration());

            wsRegion = ws.plugins[0].addRegion({
                start: song.start,
                end: song.start + song.duration,
                color: 'rgba(29, 185, 84, 0.3)', 
                drag: true,
                resize: true
            });
            updateRegionInfo(wsRegion);
        });

        ws.plugins[0].on('region-updated', (region) => { wsRegion = region; updateRegionInfo(region); });
        ws.on('play', () => document.getElementById('editor-play-btn').innerHTML = '<i class="fa-solid fa-pause"></i>');
        ws.on('pause', () => document.getElementById('editor-play-btn').innerHTML = '<i class="fa-solid fa-play"></i>');
    }

    function toggleEditorPlay() { if (ws) ws.playPause(); }
    function previewRegion() { if (ws && wsRegion) wsRegion.play(); }
    
    function formatTimeDetailed(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        const ms = Math.floor((seconds % 1) * 100); 
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
    }

    function updateRegionInfo(region) {
        document.getElementById('region-start').innerText = formatTimeDetailed(region.start);
        document.getElementById('region-duration').innerText = formatTimeDetailed(region.end - region.start);
    }

    function saveEditor() {
        const song = playlist.find(s => s.id === currentEditId);
        if (song && wsRegion) {
            song.start = wsRegion.start;
            song.duration = wsRegion.end - wsRegion.start;
            renderList();
            closeEditor();
        }
    }

    function closeEditor() {
        if (ws) ws.pause();
        const modal = document.getElementById('editor-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => { modal.classList.add('hidden'); if (ws) ws.destroy(); ws = null; }, 200);
    }

    // ==========================================
    // 3. 基础 & 导出
    // ==========================================

    function exportImage() {
        if (playlist.length === 0) return alert("List empty");
        const container = document.getElementById('export-canvas');
        const ul = document.getElementById('export-list-ul');
        ul.innerHTML = '';
        const list = (isRandomMode && playQueue.length) ? playQueue : playlist;

        list.forEach((song, i) => {
            let title = song.name; let artist = ""; const separator = " - "; 
            if (title.includes(separator)) { const parts = title.split(separator); title = parts[0]; artist = parts.slice(1).join(separator); } 
            else if (title.includes("-")) { const parts = title.split("-"); if (parts.length > 1) { title = parts[0].trim(); artist = parts.slice(1).join("-").trim(); } }

            const li = document.createElement('li');
            li.className = "flex items-start gap-6";
            li.innerHTML = `<span class="text-3xl font-black text-zinc-700 font-mono w-16 text-right pt-1">${String(i + 1).padStart(2, '0')}</span><div class="flex flex-col"><span class="text-xl font-bold text-white leading-tight tracking-tight">${title}</span>${artist ? `<span class="text-4xl text-zinc-500 font-medium mt-1 tracking-wide">${artist}</span>` : ''}</div>`;
            ul.appendChild(li);
        });

        container.style.display = 'block';
        html2canvas(container, { backgroundColor: "#080808", scale: 2, useCORS: true }).then(canvas => {
            const link = document.createElement('a'); link.download = `RDP_List_${Date.now()}.png`; link.href = canvas.toDataURL(); link.click();
        });
    }

    function handleFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(file => {
            const cleanName = file.name.replace(/\.[^/.]+$/, "");
            const existing = playlist.find(s => s.name === cleanName && !s.file && !s.url);
            if (existing) existing.file = file;
            else playlist.push({ id: Math.random().toString(36).substr(2,9), name: cleanName, file: file, start: 0, duration: 30 });
        });
        updateUI();
    }

    function loadConfig(file) {
        if (!file) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                const d = JSON.parse(e.target.result);
                playlist = d.songs.map(s => {
                    // 保留之前的 Blob 如果名字一样 (用于重复导入配置)
                    const exist = playlist.find(p => p.name === s.name && p.file);
                    return { ...s, file: exist ? exist.file : null, id: s.id || Math.random().toString(36).substr(2,9) };
                });
                updateUI();
                
                // --- 自动检测下载 ---
                const needsDl = playlist.filter(s => s.url && !s.file);
                if (needsDl.length > 0) {
                    if (confirm(`Imported ${needsDl.length} songs with remote URLs.\nDownload now for smooth playback?`)) {
                        startDownloadProcess(needsDl);
                    }
                }
            } catch(e){ alert("JSON Error"); }
        };
        r.readAsText(file);
    }

    function saveConfig() {
        if (!playlist.length) return;
        const blob = new Blob([JSON.stringify({songs: playlist.map(s => ({id:s.id, name:s.name, start:s.start, duration:s.duration, url:s.url||null}))})], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "rdp_config.json"; a.click();
    }

    function updateUI() {
        const has = playlist.length > 0;
        document.getElementById('empty-state').classList.toggle('hidden', has);
        document.getElementById('song-list-container').classList.toggle('hidden', !has);
        document.getElementById('btn-play').disabled = !has;
        renderList();
    }

    function renderList() {
        const list = isRandomMode ? playQueue : playlist;
        const ul = document.getElementById('song-list');
        ul.innerHTML = '';
        document.getElementById('list-title').innerText = isRandomMode ? "QUEUE" : "EDIT";

        list.forEach((song, i) => {
            const cur = (isRandomMode && i === currentIndex);
            // 状态图标：云端 / 本地
            const isLocal = !!song.file;
            const statusIcon = isLocal 
                ? '<i class="fa-solid fa-check text-spotify-green" title="Cached Locally"></i>' 
                : '<i class="fa-solid fa-cloud text-gray-500" title="Streamed from URL"></i>';

            const li = document.createElement('li');
            li.className = `flex justify-between p-3 rounded hover:bg-zinc-800 border-l-2 ${cur ? 'bg-zinc-800 border-spotify-green' : 'border-transparent'}`;
            li.innerHTML = `
                    <div class="flex gap-3 overflow-hidden flex-1 cursor-pointer" onclick="!isRandomMode && openEditor('${song.id}')">
                        <span class="text-xs font-mono w-6 text-right ${cur?'text-spotify-green':'text-gray-600'}">${i+1}</span>
                        <div class="flex flex-col overflow-hidden">
                            <span class="text-sm font-medium truncate ${song.file||song.url?'text-white':'text-red-500'}">
                                ${song.name}
                            </span>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-gray-500 font-mono">
                                    ${formatTimeSimple(song.start)} - ${formatTimeSimple(song.start+song.duration)}
                                </span>
                                <span class="text-[9px]">${statusIcon}</span>
                            </div>
                        </div>
                    </div>
                    ${!isRandomMode ? `<div class="flex gap-3 text-gray-400"><button onclick="openEditor('${song.id}')"><i class="fa-solid fa-pen"></i></button><button onclick="removeSong('${song.id}')"><i class="fa-solid fa-trash"></i></button></div>` : ''}
                `;
            ul.appendChild(li);
        });
    }

    function removeSong(id) { playlist = playlist.filter(s => s.id !== id); updateUI(); }

    function startRandomMode() {
        if (playlist.length === 0) return;
        // 检查是否还有未缓存的
        const uncached = playlist.filter(s => s.url && !s.file).length;
        if (uncached > 0) {
            if (!confirm(`${uncached} songs are not cached and will stream from URL (might be slow). Start anyway?`)) return;
        }

        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        playQueue = [...playlist].sort(() => Math.random() - 0.5);
        isRandomMode = true; currentIndex = -1;
        document.getElementById('btn-mode-random').classList.add('hidden');
        document.getElementById('btn-stop').classList.remove('hidden');
        document.getElementById('btn-prev').disabled = false;
        document.getElementById('btn-next').disabled = false;
        updateUI(); playNext();
    }

    function stopAll() {
        stopTimerAndAudio();
        isRandomMode = false; currentIndex = -1;
        document.getElementById('btn-mode-random').classList.remove('hidden');
        document.getElementById('btn-stop').classList.add('hidden');
        document.getElementById('player-title').innerText = "Ready";
        document.getElementById('player-status').innerText = "--";
        document.getElementById('progress-bar').style.width = '0';
        updateUI();
    }

    function startCountdown(song) {
        const l = document.getElementById('countdown-layer');
        const n = document.getElementById('cnt-num');
        document.getElementById('cnt-next-name').innerText = song.name;
        l.classList.remove('hidden');
        let c = 3; n.innerText = c; playBeep(800, 0.1);
        const t = setInterval(() => {
            c--;
            if (c>0) { n.innerText = c; playBeep(800, 0.1); }
            else if (c===0) { n.innerText = "GO!"; playBeep(1200, 0.4, 'square'); }
            else { clearInterval(t); l.classList.add('hidden'); playSong(song); }
        }, 1000);
    }

    function playBeep(f,d,t='sine'){if(!audioCtx)return;const o=audioCtx.createOscillator();const g=audioCtx.createGain();o.type=t;o.frequency.value=f;o.connect(g);g.connect(audioCtx.destination);o.start();g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d);}
    function formatTimeSimple(s) { 
        if (isNaN(s)) return "0:00";
        return Math.floor(s/60)+':'+Math.floor(s%60).toString().padStart(2,'0'); 
    }
</script>
</body>
</html>
